# 12.Memory Order
## 内存类型
ARMv8 架构定义了两种互斥的内存类型。所有内存区域都配置为这两种类型中的一种，即 Normal 和 Device。

在ARMv8架构里，页表不再包含具体的cache属性配置，而只包含1个3bit的index，这个index就是指向MAIR_EL*的某一个Attr，每一个Attr可以配置成不同的cache属性。

![mem_attr](vx_images/25354197424971.png)
## 共享域
* 非共享（Non-shareable）域
处于这个域中的内存只由当前CPU核访问，既然只能自己访问，那当然不用考虑跟系统中的其它模块，如其它CPU核或其它设备之间的数据同步问题。所以，如果一个内存区域是非共享的，系统中没有任何硬件会保证其缓存一致性。如果一不小心共享出去了，别的CPU核可以访问了，那必须由软件自己来保证其一致性。

* 内部共享（Inner Shareable）域
处于这个域中的内存可以由系统中的多个模块同时访问，并且系统硬件保证对于这段内存，对于处于同一个内部共享域中的所有模块，保证缓存一致性。

一个系统中可以同时存在多个内部共享域，对一个内部共享域做出的操作不会影响另外一个内部共享域。

* 外部共享（Outer Shareable）域
处于这个域中的内存也可以由系统中的多个模块同时访问，并且系统硬件保证对于这段内存，对于处于同一个外部共享域中的所有模块，保证缓存一致性。外部共享域可以包含一个或多个内部共享域，但是一个内部共享域只能属于一个外部共享域，不能被多个外部共享域共享。

对一个外部共享域做出的操作会影响到其包含的所有的内部共享域。

* 全系统共享（Full System）域
这个很好理解，表示对内存的修改可以被系统中的所有模块都感知到。

在一个具体的系统中，不同域的划分是由硬件平台设计者决定的，不由软件控制。并且，Arm的文档中也没有提及具体要怎么划分。但有一些指导原则，一般在一个操作系统中可以看到的所有CPU核要分配在一个内部域里面，如下图所示：
![shareable](vx_images/547866096548728.png)
## 内存屏障
• 指令同步屏障 (ISB) 这用于保证再次获取任何后续指令，以便使用当前 MMU 配置检查特权和访问。它
用于确保任何先前执行的上下文更改操作，例如写入系统控制寄存器，在 ISB 完成时已经完成。例如，
在硬件方面，这可能意味着指令流水线被刷新。它的典型用途是内存管理、缓存控制和上下文切换代
码，或者代码在内存中移动的地方。（*最严格，确保后面的指令从cache或内存重新获取*）

• 数据存储屏障 (DMB) 这防止了跨屏障指令的数据访问指令的重新排序。该处理器在 DMB 之前执行的
所有数据访问，即加载或存储，但不是指令提取，在 DMB 之后的任何数据访问之前，对指定可共享域
内的所有其他主控器都是可见的。（*保证前面的指令先于后面的指令执行，但不能保证前面的指令比后面的指令先执行完*）
（*如果dmb前后的两次访存指令访问的都是同一个终点（比如都是ddr，或者都是spi的fifo），它在能保证两次访问放射顺序的同时，其实就能保证实际的完成顺序了。因为我们访问的是同一个终点，访问路径是一致的，在这种背景下谁先执行谁就先完成。在这种场景下使用DMB相对于DSB就能提升性能。*）

• 数据同步屏障 (DSB) 这强制执行与数据存储器屏障相同的顺序，但具有阻止执行任何进一步指令的额
外效果，而不仅仅是加载或存储，或两者兼而有之，直到同步完成。这可用于防止执行 SEV 指令，例
如，该指令将向其他内核发出事件发生的信号。它一直等到此处理器发出的所有高速缓存、TLB 和分
支预测器维护操作都已针对指定的可共享域完成。（*保证前面指令的内存操作完成后才会执行后面指令*）
![option](vx_images/264152386055371.png)
